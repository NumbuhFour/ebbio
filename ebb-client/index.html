<!doctype html>
<html>
<meta charset='utf-8' lang='en'>

<head>

<script src='/socket.io/socket.io.js'></script>
<script>
  var socket = io.connect();
  var player, users = {};
  var c, ctx;
  var mouse = mousePrev = {x:0,y:0};

  socket.on('chatter', function(data){
  	displayMessage(data.user.name, data.message);
  })

  window.onload = function(){
  	initialize();
  }

  function initialize(){
  	c = document.querySelector('canvas');
  	c.width = window.innerWidth;
  	c.height = window.innerHeight;
  	ctx = c.getContext('2d');

  	player = new User('placeholder', 'placeholder');

  	socket.on('joining', function(data){
  	  player.id = data.user.id;
  	  player.name = data.user.name;
  	  player.joined = data.user.joined;

  	  socket.emit('joined', player);
  	  window.onbeforeunload = function(){socket.emit('leaving', player);};
  	});

  	socket.on('joined', function(data){
  		console.log('joined');
  		users = data;
  	})

  	socket.on('moved', function(data){
  		if(users[data.id]) users[data.id].loc = data.loc;
  	});

  	socket.on('leaving', function(data){
  		console.log(data.id+' left');
  		delete users[data.id];
  	});

  	window.onmousemove = handleMouseMove;

  	window.requestAnimationFrame(update);
  }

  function update(timestamp){
  	draw(ctx);
  	window.requestAnimationFrame(update);
  }

  function handleMouseMove(e){
  	getMouseLoc(e);
  	player.loc = mouse;
  	player.rot = getRotation(player.loc);
  	socket.emit('moved', player);
  }

  function draw(ctx){
  	ctx.fillStyle = "white";
  	ctx.fillRect(0,0,c.width,c.height);
  	drawUsers(ctx, users);
  }

  function drawUsers(ctx, users){
  	var keys = Object.keys(users);
  	for(var i=0; i<keys.length; i++){
  		drawUser(ctx, users[keys[i]]);
  	}
  }

  function drawUser(ctx, user){
  	ctx.save();
  	ctx.fillStyle = "black";
  	ctx.beginPath();
  	//ctx.arc(user.loc.x, user.loc.y, 25, 0, 2*Math.PI);
  	ctx.translate(user.loc.x-20, user.loc.y+10);
  	ctx.rotate(user.rot);
  	ctx.fillRect(0,0,40,60);
  	ctx.stroke();
  	ctx.restore();
  }

  function getMouseLoc(e){
  	mousePrev = mouse;
  	mouse.x = e.clientX;
  	mouse.y = e.clientY;
  }

  var User = function(id, name, joined){
  	// User info
  	this.id = id;
  	this.name = name;

  	// Gameplay info
  	this.loc = {x:0,y:0};
  	this.rot = 0;
  }

  function getRotation(loc){
  	var origin = {x:c.width/2,y:c.height/2};
  	return dotProduct(loc, origin)/(magnitude(loc) * magnitude(origin));
  }

  function dotProduct(v1, v2){
  	return (v1.x * v2.x) + (v1.y * v2.y);
  }

  function magnitude(v){
  	return Math.sqrt(Math.pow(Math.abs(v.x),2)+Math.pow(Math.abs(v.y),2));
  }

</script>
</head>

<body>
    <canvas></canvas>
 </body>

</html>