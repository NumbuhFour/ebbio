<!doctype html>
<html>
<meta charset='utf-8' lang='en'>

<head>
<style type="text/css">
	* { margin: 0; padding: 0; box-sizing: border-box; }
    body { font: 13px Helvetica, Arial; }
    form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
    form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
    form button { width: 9%; border: none; padding: 10px; }
    #messages { list-style-type: none; margin: 0; padding: 0; }
    #messages li { padding: 5px 10px; }
    #messages li:nth-child(odd) { background: #eee; }
</style>

<script src='/socket.io/socket.io.js'></script>
<script>
  var socket = io.connect();
  var player, users = {};
  var c, ctx;
  var mouse = {x:0,y:0};

  socket.on('chatter', function(data){
  	displayMessage(data.user.name, data.message);
  })

  window.onload = function(){
  	initialize();
  }

  function initialize(){
  	c = document.querySelector('canvas');
  	c.width = window.innerWidth;
  	c.height = window.innerHeight;
  	ctx = c.getContext('2d');

  	player = new User('placeholder', 'placeholder');

  	socket.on('joining', function(data){
  	  player.id = data.user.id;
  	  player.name = data.user.name;
  	  player.joined = data.user.joined;

  	  socket.emit('joined', player);
  	  window.onbeforeunload = function(){socket.emit('leaving', player);};
  	});

  	socket.on('joined', function(data){
  		console.log('joined');
  		users = data;
  	})

  	socket.on('moved', function(data){
  		if(users[data.id]) users[data.id].loc = data.loc;
  	});

  	socket.on('leaving', function(data){
  		console.log(data.id+' left');
  		delete users[data.id];
  	});

  	window.onmousemove = handleMouseMove;

  	window.requestAnimationFrame(update);
  }

  function update(timestamp){
  	draw(ctx);
  	window.requestAnimationFrame(update);
  }

  function handleMouseMove(e){
  	getMouseLoc(e);
  	player.loc = mouse;
  	socket.emit('moved', player);
  }

  function draw(ctx){
  	ctx.fillStyle = "white";
  	ctx.fillRect(0,0,c.width,c.height);
  	drawUsers(ctx, users);
  }

  function drawUsers(ctx, users){
  	var keys = Object.keys(users);
  	for(var i=0; i<keys.length; i++){
  		drawUser(ctx, users[keys[i]]);
  	}
  }

  function drawUser(ctx, user){
  	ctx.fillStyle = "black";
  	ctx.beginPath();
  	ctx.arc(user.loc.x, user.loc.y, 25, 0, 2*Math.PI);
  	ctx.stroke();
  }

  function getMouseLoc(e){
  	mouse.x = e.clientX;
  	mouse.y = e.clientY;
  }

  var User = function(id, name, joined){
  	// User info
  	this.id = id;
  	this.name = name;

  	// Gameplay info
  	this.loc = {x:0,y:0};
  	this.rot = 0;
  }

</script>
</head>

<body>
    <canvas></canvas>
 </body>

</html>